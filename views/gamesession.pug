html
    head
        meta(name="viewport", content="width=device-width, initial-scale=1.0")
        title Game Session
        link(rel="stylesheet", href="/styles/gamesession.css")
        script(src="https://cdn.socket.io/4.7.4/socket.io.min.js")
        script(src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js")
        script(src="https://unpkg.com/html5-qrcode@2.3.8")
        script(src="https://kit.fontawesome.com/your-kit-code.js" crossorigin="anonymous")
    
    body
        .game-container
            h2 Game Session
            p Player: #{username}
            p Score: #[span#playerScore #{score}]
            p Please scan the QR code to answer the question.

            button#scanBtn Scan Question Card
            #reader

            #questionModal.question-modal
                h3#questionText
                form#answerForm
                    #options
                    button#submitAnswer(type="submit") Submit Answer

            if is_host
                button#endGameBtn End Game

        button#toggleRankings.toggle-rankings-btn
            i.fas.fa-trophy
            span Rankings

        audio#bgMusic(src="/audio/session.mp3" loop)

        button#toggleAudio.toggle-audio-btn
            i.fas.fa-volume-up
            span Audio

        .rankings-container
            h3 Current Rankings
            #rankingsList

        script.
            $(document).ready(function() {
                // Update Socket.IO connection
                const socket = io('http://localhost:3000');
                const sessionId = '#{sessionId}';
                let checkGameStatus;

                socket.on('connect', () => {
                    console.log('Connected to socket server');
                    socket.emit('joinGame', sessionId);
                });

                socket.on('redirectToCalculation', (data) => {
                    console.log('Received redirect signal');
                    window.location.href = `/calculation/${sessionId}`;
                });

                let html5QrcodeScanner = null;
                let currentCardId = null;

                $('#scanBtn').click(function() {
                    if (!html5QrcodeScanner) {
                        const config = {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        };

                        html5QrcodeScanner = new Html5QrcodeScanner("reader", config);
                        html5QrcodeScanner.render(onScanSuccess, onScanError);
                    }
                });

                function onScanSuccess(decodedText) {
                    currentCardId = decodedText;
                    console.log('QR Code detected:', currentCardId);
                    
                    $.get(`/gamesession/question/${currentCardId}`, function(response) {
                        if (response.success) {
                            showQuestion(response.question);
                            if (html5QrcodeScanner) {
                                html5QrcodeScanner.clear();
                                html5QrcodeScanner = null;
                            }
                        } else {
                            alert('Invalid QR code');
                        }
                    });
                }

                function showQuestion(question) {
                    $('#questionText').text(question.question_description);
                    
                    const options = {
                        'A': question.option_a,
                        'B': question.option_b,
                        'C': question.option_c,
                        'D': question.option_d
                    };

                    let optionsHtml = '';
                    Object.entries(options).forEach(([key, value]) => {
                        optionsHtml += `
                            <div class="option">
                                <input type="radio" name="answer" value="${key}" id="option${key}">
                                <label for="option${key}">${key}: ${value}</label>
                            </div>
                        `;
                    });
                    
                    $('#options').html(optionsHtml);
                    $('#questionModal').show();
                }

                $('#answerForm').on('submit', function(e) {
                    e.preventDefault();
                    
                    const selectedAnswer = $('input[name="answer"]:checked').val();
                    if (!selectedAnswer) {
                        alert('Please select an answer');
                        return;
                    }

                    $.post('/gamesession/answer', {
                        cardId: currentCardId,
                        sessionId: '#{sessionId}',
                        answer: selectedAnswer
                    }, function(response) {
                        if (response.success) {
                            $('#playerScore').text(response.newScore);
                            alert(response.correct ? 
                                `Correct! You earned ${response.scoreChange} points!` : 
                                `Wrong! You lost 50 points!`);
                            $('#questionModal').hide();
                            $('#answerForm')[0].reset();
                            updateRankings(); // Update rankings immediately after answer
                        } else {
                            alert(response.error || 'Error submitting answer');
                        }
                    });
                });

                // Update end game button handler
                $('#endGameBtn').click(function() {
                    if(confirm('Are you sure you want to end the game?')) {
                        $.post(`/gamesession/endgame/${sessionId}`, function(response) {
                            if(response.success) {
                                console.log('Emitting gameEnded event');
                                socket.emit('gameEnded', sessionId);
                                setTimeout(() => {
                                    window.location.href = `/calculation/${sessionId}`;
                                }, 500);
                            } else {
                                alert('Error ending game: ' + (response.error || 'Unknown error'));
                            }
                        });
                    }
                });

                // Add polling as backup
                checkGameStatus = setInterval(() => {
                    $.get(`/gamesession/status/${sessionId}`, function(data) {
                        if(data.status === 'completed') {
                            clearInterval(checkGameStatus);
                            window.location.href = `/calculation/${sessionId}`;
                        }
                    });
                }, 1000);

                // Clear interval when leaving page
                $(window).on('beforeunload', function() {
                    clearInterval(checkGameStatus);
                });

                function updateRankings() {
                    $.get(`/gamesession/rankings/#{sessionId}`, function(data) {
                        let rankingsHtml = '<table class="rankings-table">';
                        rankingsHtml += '<tr><th>Position</th><th>Player</th><th>Score</th></tr>';
                        
                        data.rankings.forEach(player => {
                            rankingsHtml += `
                                <tr>
                                    <td>#${player.current_position}</td>
                                    <td>${player.username}</td>
                                    <td>${player.score}</td>
                                </tr>
                            `;
                        });
                        
                        rankingsHtml += '</table>';
                        $('#rankingsList').html(rankingsHtml);
                    });
                }

                // Initial rankings update and start polling
                updateRankings();
                setInterval(updateRankings, 1000);

                function onScanError(error) {
                    console.warn('QR Code scan error:', error);
                }

                // Initialize rankings visibility
                let rankingsVisible = false;
                if (window.innerWidth >= 768) {
                    $('.rankings-container').show();
                    rankingsVisible = true;
                    $('#toggleRankings').hide();
                } else {
                    $('.rankings-container').hide();
                    $('#toggleRankings').show();
                }

                // Toggle rankings handler
                $('#toggleRankings').click(function() {
                    rankingsVisible = !rankingsVisible;
                    $('.rankings-container').slideToggle();
                    $(this).html(
                        rankingsVisible ? 
                        '<i class="fas fa-times"></i><span>Close</span>' : 
                        '<i class="fas fa-trophy"></i><span>Rankings</span>'
                    );
                });

                // Handle window resize
                $(window).resize(function() {
                    if (window.innerWidth >= 768) {
                        $('.rankings-container').show();
                        rankingsVisible = true;
                        $('#toggleRankings').hide();
                    } else {
                        if (!rankingsVisible) {
                            $('.rankings-container').hide();
                        }
                        $('#toggleRankings').show();
                    }
                });

                let audioPlaying = true;
                const bgMusic = document.getElementById('bgMusic');

                bgMusic.play().catch(function(error) {
                    console.log("Audio autoplay failed:", error);
                    // Modern browsers require user interaction before playing audio
                    audioPlaying = false;
                    $('#toggleAudio').html('<i class="fas fa-volume-mute"></i><span>Audio</span>');
                });

                $('#toggleAudio').click(function() {
                    audioPlaying = !audioPlaying;
                    if (audioPlaying) {
                        bgMusic.play();
                        $(this).html('<i class="fas fa-volume-up"></i><span>Audio</span>');
                    } else {
                        bgMusic.pause();
                        $(this).html('<i class="fas fa-volume-mute"></i><span>Audio</span>');
                    }
                });

                // Handle page visibility change to manage audio
                document.addEventListener('visibilitychange', function() {
                    if (document.hidden && audioPlaying) {
                        bgMusic.pause();
                    } else if (!document.hidden && audioPlaying) {
                        bgMusic.play();
                    }
                });
            });