html
    head
        meta(name="viewport", content="width=device-width, initial-scale=1.0")
        title Game Room
        link(rel="stylesheet", href="/styles/gameroom.css")
        script(src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js")
        
    body
        .lobby-container
            .header
                span.room-id Room ID: #{join_code}
                span.room-name Game Name: #{game_name}

            .player-slots
                // Player slots will be filled by AJAX

            .actions
                if is_host
                    button#startGame(type="button") Start Game
                else
                    button#readyBtn(type="button") Ready
                button#leaveLobby(type="button") Leave Lobby

        script.
            $(document).ready(function() {
                let playerCount = 0;
                let isPlayerReady = false;

                function updatePlayers() {
                    // Fetch player data from the server
                    $.get('/gameroom/players/#{session_id}', function(data) {
                        let slotsHtml = '';
                        playerCount = data.players.length;
                        
                        // Update player's ready status
                        const currentPlayer = data.players.find(p => p.user_id === '#{user_id}');
                        if (currentPlayer) {
                            isPlayerReady = currentPlayer.is_ready === 1;
                            if (!currentPlayer.is_host) {
                                $('#readyBtn').text(isPlayerReady ? 'Unready' : 'Ready');
                            }
                        }

                        // Player slots
                        for (let i = 0; i < 4; i++) {
                            if (data.players[i]) {
                                const p = data.players[i];
                                slotsHtml += `<div class="player-slot">
                                    <span>${p.username}</span>
                                    ${p.is_host ? '<span style="float:right;">Host</span>' : (p.is_ready ? '<span style="float:right;">Ready</span>' : '<span style="float:right;">Not Ready</span>')}
                                </div>`;
                            } else {
                                slotsHtml += `<div class="player-slot"><span>+</span></div>`;
                            }
                        }
                        $('.player-slots').html(slotsHtml);

                        // Update start button state for host
                        if ('#{is_host}' === 'true') {
                            const allPlayersReady = data.players.every(p => p.is_host === 1 || p.is_ready === 1);
                            const validPlayerCount = playerCount >= 2 && playerCount <= 4;
                            $('#startGame').prop('disabled', !(allPlayersReady && validPlayerCount));
                        }
                    });
                }

                // Initial player update
                updatePlayers();
                setInterval(updatePlayers, 500);

                // Ready button click handler
                $('#readyBtn').click(function() {
                    const newReadyState = !isPlayerReady;
                    $.post('/gameroom/ready', { 
                        session_id: '#{session_id}',
                        ready_state: newReadyState
                    }, function(res) {
                        if(res.success) {
                            isPlayerReady = newReadyState;
                            $(this).text(isPlayerReady ? 'Unready' : 'Ready');
                            updatePlayers();
                        }
                    }.bind(this));
                });

                // Start game button click handler
                $('#startGame').click(function() {
                    $.post('/gameroom/start', { session_id: '#{session_id}' }, function(res) {
                        if (res.success) {
                            window.location.href = res.redirect;
                        } else {
                            alert(res.error);
                        }
                    });
                });

                // Leave lobby button click handler
                $('#leaveLobby').click(function() {
                    window.location.href = '/dashboard';
                });
                setInterval(function() {
                    $.get('/gameroom/status/' + '#{session_id}', function(res) {
                        if(res.status === 'active') window.location.href = '/gamesession/' + '#{session_id}';
                    });
                }, 1000);
            });